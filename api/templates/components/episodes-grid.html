<!-- Episodes Grid Component -->
<div class="episodes-container">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 md:mb-6 gap-3">
        <h3 class="text-lg md:text-xl font-semibold text-purple-400">All Episodes</h3>
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label for="jumpToEpisode" class="text-xs md:text-sm text-gray-400 whitespace-nowrap">Jump to:</label>
                <input 
                    type="number" 
                    id="jumpToEpisode" 
                    min="1" 
                    max="{% if episodes and episodes.episodes %}{{ episodes.episodes|length }}{% else %}1{% endif %}"
                    placeholder="Ep #"
                    class="w-18 md:w-15 px-2 py-1 bg-black/30 border border-purple-500/30 rounded text-white text-xs md:text-sm focus:outline-none focus:border-purple-500 min-h-[36px]"
                >
                <button 
                    onclick="jumpToEpisode()" 
                    class="px-3 py-1 bg-purple-500 hover:bg-purple-600 rounded text-white text-xs md:text-sm transition-colors duration-200 min-h-[36px] flex items-center justify-center">
                    Go
                </button>
            </div>
            <span class="text-xs md:text-sm text-gray-400 whitespace-nowrap">
                {% if episodes and episodes.episodes %}{{ episodes.episodes|length }} episodes{% endif %}
            </span>
        </div>
    </div>

    <!-- Add legend showing episode status indicators -->
    <div class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b border-gray-700/50">
        <div class="flex items-center gap-2 text-xs text-gray-400">
            <div class="w-3 h-3 bg-gray-600 rounded"></div>
            <span>Unwatched</span>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-400">
            <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
            <span>Watched</span>
        </div>
    </div>

    <div class="episodes-grid" id="episodesGrid">
        {% if episodes and episodes.episodes %}
            {% for episode in episodes.episodes %}
                {% set ep_parts = episode.episodeId.split('?') %}
                {% set ep_slug = ep_parts[0] %}
                {% set ep_query = ep_parts[1] if ep_parts|length > 1 else '' %}
                {% set ep_param = ep_query.split('ep=')[1].split('&')[0] if 'ep=' in ep_query else '' %}
                
                <!-- Add data attributes for watch status tracking -->
                <a href="/watch/{{ ep_slug }}?ep={{ ep_param }}-{{ lang if lang else 'sub' }}{% if selected_server %}&server={{ selected_server }}{% endif %}"
                   class="episode-card {% if episode_number and episode.number == episode_number|int %}current{% endif %}"
                   data-episode="{{ episode.number }}"
                   data-anime-id="{{ ep_slug }}"
                   data-ep-id="{{ ep_param }}"
                   data-watch-status="unwatched">
                    <div class="episode-progress" id="progress-{{ episode.number }}" style="width: 0%"></div>
                    <div class="episode-number" id="number-{{ episode.number }}">
                        {{ episode.number }}
                    </div>
                    <div class="episode-info">
                        <div class="episode-title">{{ episode.title if episode.title else 'Episode ' + episode.number|string }}</div>
                        <div class="episode-meta">
                            <span>Episode {{ episode.number }}</span>
                            <span class="watch-time" id="time-{{ episode.number }}" style="display: none;"></span>
                        </div>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <div class="col-span-full text-center text-gray-400 py-8">
                <p>No episodes available</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Script to update episode status classes based on watch progress -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const updateEpisodeStatuses = () => {
    try {
      const episodeCards = document.querySelectorAll('.episode-card')
      episodeCards.forEach(card => {
        const episodeNumber = card.getAttribute('data-episode')
        const animeId = card.getAttribute('data-anime-id')
        const epId = card.getAttribute('data-ep-id')

        if (animeId && epId) {
          const watchData = JSON.parse(localStorage.getItem('animeWatchData') || '{}')
          const urlParams = new URLSearchParams(window.location.search)
          const ep = urlParams.get('ep')
          const langType = ep && ep.includes('-') ? ep.split('-').pop() : 'default'
          const key = `${animeId}_${epId}_${langType}`
          const progress = watchData[key]

          // Remove existing status classes
          card.classList.remove('watched', 'partially-watched')

          if (progress) {
            const percentage = (progress.watchTime / progress.totalTime) * 100

            if (progress.completed || percentage >= 90) {
              card.classList.add('watched')
              card.setAttribute('data-watch-status', 'watched')
            }
          }
        }
      })
    } catch (error) {
      console.error('[v0] Error updating episode statuses:', error)
    }
  }

  // Update on load and periodically
  updateEpisodeStatuses()
  setInterval(updateEpisodeStatuses, 2000)
})
</script>