{% extends "base.html" %}

{% block title %}{{ anime.name or anime.title or 'Anime' }} - YumeAnime{% endblock %}
{% block meta_description %}Watch {{ anime.name or anime.title }} online. {{ (anime.description or anime.synopsis or
'')[:150] }}{% endblock %}
{% block extra_css %}
<style>
    /* Seasons Section Styles */
    .seasons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: var(--space-md);
        margin-top: var(--space-md);
    }

    .season-card {
        position: relative;
        display: block;
        border-radius: var(--radius-md);
        overflow: hidden;
        aspect-ratio: 2/3;
        transition: all var(--transition-fast);
        border: 2px solid transparent;
        box-shadow: var(--shadow-sm);
    }

    .season-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        z-index: 2;
    }

    /* Current Season Highlight */
    .season-card.current {
        border-color: var(--primary-color);
        box-shadow: 0 0 15px var(--primary-color-alpha, rgba(168, 85, 247, 0.4));
        transform: scale(1.02);
    }

    .season-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }

    .season-card:hover img {
        transform: scale(1.05);
    }

    /* Improved Overlay */
    .season-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 40px 8px 8px;
        /* Extra top padding for gradient */
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.6) 60%, transparent 100%);
        color: white;
        text-align: center;
        display: flex;
        align-items: flex-end;
        justify-content: center;
    }

    .season-title {
        font-size: 0.8rem;
        font-weight: 600;
        line-height: 1.3;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);

        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Current Badge */
    .season-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        background: var(--primary-color);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        z-index: 5;
    }
</style>
{% endblock %}

{% block content %}
<div class="anime-hero">
    <!-- Banner Background -->
    <div class="anime-banner">
        <img src="{{ anime.poster or anime.image }}" alt="{{ anime.name or anime.title }}">
    </div>

    <div class="container">
        <div class="anime-info-container">
            <div class="anime-info-grid">
                <!-- Poster -->
                <div class="anime-poster">
                    <img src="{{ anime.poster or anime.image }}" alt="{{ anime.name or anime.title }}">
                </div>

                <!-- Details -->
                <div class="anime-details">
                    <h1 class="anime-title">{{ anime.name or anime.title }}</h1>
                    {% if anime.jname or anime.japanese_title %}
                    <p class="anime-alt-title">{{ anime.jname or anime.japanese_title }}</p>
                    {% endif %}

                    <!-- Stats -->
                    <div class="anime-stats">
                        {% if anime.stats and anime.stats.rating %}
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--warning);">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"
                                    style="vertical-align: middle;">
                                    <polygon
                                        points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                </svg>
                                {{ anime.stats.rating }}
                            </div>
                            <div class="stat-label">Rating</div>
                        </div>
                        {% endif %}
                        {% if anime.stats and anime.stats.episodes and anime.stats.episodes.sub %}
                        <div class="stat-item">
                            <div class="stat-value">{{ anime.stats.episodes.sub }}</div>
                            <div class="stat-label">Episodes</div>
                        </div>
                        {% endif %}
                        {% if anime.stats and anime.stats.episodes and anime.stats.episodes.dub %}
                        <div class="stat-item">
                            <div class="stat-value">{{ anime.stats.episodes.dub }}</div>
                            <div class="stat-label">Dubbed</div>
                        </div>
                        {% endif %}
                        {% if anime.stats and anime.stats.type %}
                        <div class="stat-item">
                            <div class="stat-value">{{ anime.stats.type }}</div>
                            <div class="stat-label">Type</div>
                        </div>
                        {% endif %}
                        {% if anime.stats and anime.stats.duration %}
                        <div class="stat-item">
                            <div class="stat-value">{{ anime.stats.duration }}</div>
                            <div class="stat-label">Duration</div>
                        </div>
                        {% endif %}
                        {% if anime.status %}
                        <div class="stat-item">
                            <div class="stat-value">{{ anime.status }}</div>
                            <div class="stat-label">Status</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions - Placed first for quick access -->
                    <div class="anime-actions" style="margin-bottom: var(--space-xl);">
                        <a href="/episodes/{{ anime.id or current_season_id }}" class="btn btn-primary btn-lg">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3" />
                            </svg>
                            Watch Now
                        </a>
                        <button class="btn btn-secondary btn-lg" id="add-to-watchlist"
                            data-anime-id="{{ anime.id or current_season_id }}"
                            data-anime-title="{{ anime.name or anime.title }}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                            </svg>
                            <span id="watchlist-btn-text">Add to List</span>
                        </button>
                    </div>

                    <!-- Genres -->
                    {% if anime.genres %}
                    <div class="anime-genres">
                        {% for genre in anime.genres %}
                        <a href="/genre/{{ genre | lower | replace(' ', '-') }}" class="genre-tag">{{ genre }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Synopsis -->
                    <div class="anime-synopsis">
                        <h3>Synopsis</h3>
                        <p>{{ anime.description or anime.synopsis or 'No description available.' }}</p>
                    </div>

                    <!-- Additional Info -->
                    {% if anime.moreInfo %}
                    <div class="anime-more-info" style="margin-bottom: var(--space-xl);">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md);">
                            {% if anime.moreInfo.studios and anime.moreInfo.studios | length > 0 %}
                            <div>
                                <span class="text-muted text-sm">Studios:</span>
                                <span>{{ anime.moreInfo.studios | join(', ') }}</span>
                            </div>
                            {% endif %}
                            {% if anime.moreInfo.producers and anime.moreInfo.producers | length > 0 %}
                            <div>
                                <span class="text-muted text-sm">Producers:</span>
                                <span>{{ anime.moreInfo.producers | join(', ') }}</span>
                            </div>
                            {% endif %}
                            {% if anime.moreInfo.premiered %}
                            <div>
                                <span class="text-muted text-sm">Premiered:</span>
                                <span>{{ anime.moreInfo.premiered }}</span>
                            </div>
                            {% endif %}
                            {% if anime.moreInfo.aired %}
                            <div>
                                <span class="text-muted text-sm">Aired:</span>
                                <span>{{ anime.moreInfo.aired }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Related & Recommended -->
<div class="container" style="margin-top: var(--space-3xl);">
    {% if anime.seasons and anime.seasons | length > 0 %}
    <section class="section" style="margin-bottom: var(--space-xl);">
        <div class="section-header">
            <h2 class="section-title">Seasons</h2>
        </div>
        <div class="seasons-grid">
            {% for season in anime.seasons %}
            <a href="/anime/{{ season.id }}" class="season-card {% if season.isCurrent %}current{% endif %}">
                {% if season.isCurrent %}
                <div class="season-badge">NOW</div>
                {% endif %}
                <img src="{{ season.poster }}" alt="{{ season.title }}" loading="lazy">
                <div class="season-overlay">
                    <div class="season-title">{{ season.title or season.name }}</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if suggestions and suggestions.related and suggestions.related | length > 0 %}
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Related Anime</h2>
        </div>
        <div class="anime-grid">
            {% for related in suggestions.related[:6] %}
            <a href="/anime/{{ related.id }}" class="anime-card">
                <div class="anime-card-poster">
                    <img src="{{ related.poster or related.image }}" alt="{{ related.name or related.title }}"
                        loading="lazy">
                    <div class="anime-card-badges">
                        {% if related.episodes and related.episodes.sub %}
                        <span class="badge badge-sub">{{ related.episodes.sub }}</span>
                        {% endif %}
                        {% if related.episodes and related.episodes.dub %}
                        <span class="badge badge-dub">{{ related.episodes.dub }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="anime-card-info">
                    <h3 class="anime-card-title">{{ related.name or related.title }}</h3>
                    <div class="anime-card-meta">
                        {% if related.type %}<span>{{ related.type }}</span>{% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if suggestions and suggestions.recommended and suggestions.recommended | length > 0 %}
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Recommended</h2>
        </div>
        <div class="anime-grid">
            {% for rec in suggestions.recommended[:6] %}
            <a href="/anime/{{ rec.id }}" class="anime-card">
                <div class="anime-card-poster">
                    <img src="{{ rec.poster or rec.image }}" alt="{{ rec.name or rec.title }}" loading="lazy">
                    <div class="anime-card-badges">
                        {% if rec.episodes and rec.episodes.sub %}
                        <span class="badge badge-sub">{{ rec.episodes.sub }}</span>
                        {% endif %}
                        {% if rec.episodes and rec.episodes.dub %}
                        <span class="badge badge-dub">{{ rec.episodes.dub }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="anime-card-info">
                    <h3 class="anime-card-title">{{ rec.name or rec.title }}</h3>
                    <div class="anime-card-meta">
                        {% if rec.type %}<span>{{ rec.type }}</span>{% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Watchlist functionality
    const addToWatchlistBtn = document.getElementById('add-to-watchlist');
    const watchlistBtnText = document.getElementById('watchlist-btn-text');

    if (addToWatchlistBtn) {
        // Check current status
        const animeId = addToWatchlistBtn.dataset.animeId;

        fetch(`/api/watchlist/status?anime_id=${encodeURIComponent(animeId)}`)
            .then(r => r.json())
            .then(data => {
                if (data.in_watchlist) {
                    watchlistBtnText.textContent = data.status || 'In List';
                    addToWatchlistBtn.classList.add('active');
                }
            })
            .catch(() => { });

        addToWatchlistBtn.addEventListener('click', async function () {
            const animeId = this.dataset.animeId;
            const animeTitle = this.dataset.animeTitle;

            try {
                const response = await fetch('/api/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        anime_id: animeId,
                        anime_title: animeTitle,
                        status: 'watching'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    watchlistBtnText.textContent = 'Added!';
                    this.classList.add('active');
                } else if (response.status === 401) {
                    openLoginModal();
                } else {
                    alert(data.message || 'Failed to add to watchlist');
                }
            } catch (e) {
                console.error('Watchlist error:', e);
            }
        });
    }
</script>
{% endblock %}