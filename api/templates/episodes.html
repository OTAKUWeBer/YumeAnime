{% extends "base.html" %}

{% block title %}{{ title }} Episodes - YumeAnime{% endblock %}
{% block meta_description %}Watch {{ title }} episodes online. {{ total_episodes }} episodes available.{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div style="margin-bottom: var(--space-xl);">
        <a href="/anime/{{ anime_id }}" class="btn btn-ghost" style="margin-bottom: var(--space-md);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6" />
            </svg>
            Back to Anime
        </a>
        <h1>{{ title }}</h1>
        <div class="anime-card-meta" style="margin-top: var(--space-sm);">
            <span>{{ status }}</span>
            <span>{{ genre }}</span>
            <span>{{ total_episodes }} Episodes</span>
        </div>
    </div>

    <!-- Episode Stats -->
    <div class="watchlist-stats" style="margin-bottom: var(--space-xl);">
        <div class="stat-card">
            <div class="stat-card-value">{{ total_episodes }}</div>
            <div class="stat-card-label">Total Episodes</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value" style="color: var(--badge-sub);">{{ total_sub_episodes }}</div>
            <div class="stat-card-label">Subbed</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value" style="color: var(--badge-dub);">{{ total_dub_episodes }}</div>
            <div class="stat-card-label">Dubbed</div>
        </div>
    </div>

    <!-- Episode Search/Filter (optional) -->
    <div style="margin-bottom: var(--space-lg); display: flex; gap: var(--space-md); flex-wrap: wrap;">
        <input type="text" class="search-input" id="episode-search" placeholder="Search episode..."
            style="max-width: 300px; border-radius: var(--radius-md);">
        <select class="server-select" id="episode-filter">
            <option value="all">All Episodes</option>
            <option value="1-12">1-12</option>
            <option value="13-24">13-24</option>
            <option value="25-50">25-50</option>
            <option value="51+">51+</option>
        </select>
    </div>

    <!-- Episodes Grid -->
    <div class="episode-grid" id="episode-grid">
        {% for episode_url, episode_number, episode_title in episodes %}
        <a href="/watch/{{ episode_url }}" class="episode-item" data-episode="{{ episode_number }}"
            data-title="{{ episode_title }}">
            <div>
                <div style="font-size: 1.25rem; font-weight: 600;">{{ episode_number }}</div>
                {% if episode_title and episode_title != 'Episode ' + episode_number|string %}
                <div class="episode-grid-title">
                    {{ episode_title }}</div>
                {% endif %}
            </div>
        </a>
        {% else %}
        <div class="no-results" style="grid-column: 1 / -1;">
            <div class="no-results-icon">ðŸ“º</div>
            <p>No episodes available yet.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Episode search/filter - wrapped in DOMContentLoaded for safety
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('episode-search');
        const filterSelect = document.getElementById('episode-filter');
        const episodeGrid = document.getElementById('episode-grid');

        if (!episodeGrid) {
            console.error('[Episode Search] Episode grid not found');
            return;
        }

        const episodes = episodeGrid.querySelectorAll('.episode-item');
        console.log('[Episode Search] Found', episodes.length, 'episodes');

        function filterEpisodes() {
            const searchTerm = (searchInput?.value || '').toLowerCase().trim();
            const filterRange = filterSelect?.value || 'all';

            console.log('[Episode Search] Filtering:', searchTerm, filterRange);

            let visibleCount = 0;
            episodes.forEach(ep => {
                const epNum = parseInt(ep.dataset.episode) || 0;
                const epTitle = (ep.dataset.title || '').toLowerCase();

                let showBySearch = !searchTerm ||
                    epNum.toString().includes(searchTerm) ||
                    epTitle.includes(searchTerm);

                let showByFilter = true;
                if (filterRange === '1-12') showByFilter = epNum >= 1 && epNum <= 12;
                else if (filterRange === '13-24') showByFilter = epNum >= 13 && epNum <= 24;
                else if (filterRange === '25-50') showByFilter = epNum >= 25 && epNum <= 50;
                else if (filterRange === '51+') showByFilter = epNum >= 51;

                const shouldShow = showBySearch && showByFilter;
                ep.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });

            console.log('[Episode Search] Visible episodes:', visibleCount);
        }

        if (searchInput) {
            searchInput.addEventListener('input', filterEpisodes);
            searchInput.addEventListener('keyup', filterEpisodes); // Backup event
            console.log('[Episode Search] Search input listener attached');
        }
        if (filterSelect) {
            filterSelect.addEventListener('change', filterEpisodes);
            console.log('[Episode Search] Filter select listener attached');
        }
    });
</script>
{% endblock %}